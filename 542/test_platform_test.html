<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>芯片数据实时实时数据实时接收系统 - 平台层层测试</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- Tailwind CSS 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f4c81',
                        secondary: '#3a7ca5',
                        accent: '#d9dcd6',
                        warning: '#e74c3c',
                        success: '#2ecc71',
                        dark: '#1a365d',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .text-shadow {
                text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-900">
    <div class="min-h-screen-screen flex-screen flexflex flex flex flex-col">
        <!-- 顶部导航栏 -->
        <header class="bg-primary text-white shadow-md">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items items items items-center space-x-4">
                    <i class="fa fa-microchip text-2xl"></i>
                    <h1 class="text-xl font-bold">芯片数据实时接收系统</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-white hover:text-blue-200 flex items-center">
                        <i class="fa fa-arrow-left mr-1"></i> 返回主页
                    </a>
                </div>
            </div>
        </header>

        <!-- 主内容区 -->
        <main class="flex-grow p-4 md:p-6 overflow-auto">
            <!-- 测试标题 -->
            <div class="bg-white rounded-lg shadow shadow-md p-6 mb-6">
                <h2 class="text-2xl font font-bold-bold text-gray-800 mb-2">平台台层层测试测试</h2>
                <p class="text-gray-600">本页面用于测试平台层的各项功能，包括数据处理、健康评估、异常检测和数据质量管理。</p>
            </div>

            <!-- 测试控制区 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">测试控制</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">测试数据类型</label>
                        <select id="test-data-type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="normal">正常数据</option>
                            <option value="warning">警告数据</option>
                            <option value="anomaly">异常数据</option>
                            <option value="custom">自定义数据</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">数据数量</label>
                        <input type="number" id="test-data-count" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" value="100" min="1" max="1000">
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button id="start-test" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center">
                        <i class="fa fa-play mr-1"></i> 开始测试
                    </button>
                    <button id="clear-test" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-md flex items-center">
                        <i class="fa fa-trash mr-1"></i> 清除数据
                    </button>
                </div>
            </div>

            <!-- 自定义数据设置 -->
            <div id="custom-data-settings" class="bg-white rounded-lg-lg shadow-md p-6 mb-6 hidden">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">自定义数据设置</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">温度 (°C)</label>
                        <input type="number" id="custom-temperature" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" value="25.0" step="0.1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">压力值 (G)</label>
                        <input type="number" id="custom-voltage" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" value="3.3" step="0.01">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">震动程度 (Z)</label>
                        <input type="number" id="custom-current" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" value="150.0" step="0.1">
                    </div>
                    <div>
                        <label class="block text-sm font-sm-medium text-gray-700 mb-1">振动强度 (g)</label>
                        <input type="number" id="custom-vibration" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" value="0.02" step="0.001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">位移 (mm)</label>
                        <input type="number" id="custom-displacement" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" value="0.1" step="0.01">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">倾斜角度 (°)</label>
                        <input type="number" id="custom-tilt" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" value="0.5" step="0.01">
                    </div>
                </div>
            </div>

            <!-- 测试进度 -->
            <div id="test-progress" class="bg-white rounded rounded-lg-lg-lg shadow shadow-md p-6 mb-6 hidden">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">测试进度</h3>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                    <div id="progress-bar" class="bg-primary h-4 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between-between justify-between text-sm text-gray-600">
                    <span id="progress-text">0%</span>
                    <span id="data-count-text">0/0 数据点</span>
                </div>
            </div>

            <!-- 测试结果 -->
            <div id="test-results" class="bg-white rounded-lg-lg shadow-md p-6 mb-6 hidden">
                <h3 class="text-lg font font-semibold text-gray-700 mb-4">测试结果</h3>
                
                <!-- 健康健康评估健康评分 -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-2">平台层健康评分</h4>
                    <div class="flex items-center-center justify-center">
                        <div class="relative w-32 h-32">
                            <canvas id="health-score-gauge"></canvas>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="health-score-value" class="text-4xl font-bold">0</span>
                                <span class="text-sm text-gray-500">/100</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 数据质量分析 -->
                <div class="mb-6">
                    <h4 class="font-medium-medium text-gray-700 mb-2">数据质量分析</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-50 p-3 rounded-md">
                            <div class="flex justify justify-between items-center-center-center mb-1">
                                <span class="text-sm font-medium text-gray-700">数据完整性</span>
                                <span id="data-completeness" class="text-sm font-medium">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="data-completeness-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-md">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">数据准确性</span>
                                <span id="data-accuracy" class="text-sm font-medium">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="data-accuracy-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-md">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">数据稳定性</span>
                                <span id="data-stability" class="text-sm font-medium">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="data-stability-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 异常检测结果 -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-2">异常检测结果</h4>
                    <div class="bg-gray-50 p-3 rounded-md">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-700">检测到的异常</span>
                            <span id="anomaly-count" class="text-sm font-medium">0 个</span>
                        </div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-700">异常率</span>
                            <span id="anomaly-rate" class="text-sm font-medium">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- 关键指标分析 -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-2">关键指标分析</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">指标</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">平均值</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">标准差</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最小值</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最大值</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">正常范围</th>
                                </tr>
                            </thead>
                            <tbody id="metrics-table" class="bg-white divide-y divide-gray-200">
                                <!-- 指标数据将通过JavaScript动态添加 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 健康趋势图 -->
                <div class="mb-6">
                    <h4 class="font-medium text-gray-700 mb-2">健康趋势</h4>
                    <div class="h-64 bg-gray-50 p-4 rounded-md">
                        <canvas id="health-trend-chart"></canvas>
                    </div>
                </div>
                
                <!-- 测试结论 -->
                <div class="bg-gray-50 p-4 rounded-md">
                    <h4 class="font-medium text-gray-700 mb-2">测试结论</h4>
                    <div id="test-conclusion" class="text-sm text-gray-700">
                        <!-- 测试结论将通过JavaScript动态添加 -->
                    </div>
                </div>
            </div>

            <!-- 测试日志 -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">测试日志</h3>
                    <button id="clear-log" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-md text-sm flex items-center">
                        <i class="fa fa-trash mr-1"></i> 清除日志
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <div id="test-log" class="max-h-60 overflow-y-auto scrollbar-hide text-sm">
                        <div class="text-gray-500 italic">测试日志将显示在这里...</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 底部状态栏 -->
        <footer class="bg-dark text-white py-2 px-4">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
                <div class="text-sm mb-2 md:mb-0">
                    芯片数据实时接收系统 v1.0 - 平台层测试页面
                </div>
                <div class="text-sm">
                    最后更新: <span id="last-update">--:--:--</span>
                </div>
            </div>
        </footer>
    </div>

    <!-- 平台层脚本 -->
    <script src="platform_layer.js"></script>

    <script>
        // 全局变量
        let testInterval;
        let testDataCount = 0;
        let totalTestData = 0;
        let healthTrendChart;
        let healthScoreGauge;
        let healthHistory = [];
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化图表
            initializeCharts();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 更新时间
            updateTime();
            setInterval(updateTime, 1000);
            
            // 记录测试日志
            logTest('平台层测试页面已加载');
            logTest('平台层模块已初始化');
        });
        
        // 初始化图表
        function initializeCharts() {
            // 健康评分仪表盘
            const healthScoreCtx = document.getElementById('health-score-gauge').getContext('2d');
            healthScoreGauge = new Chart(healthScoreCtx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [80, 20],
                        backgroundColor: [
                            '#2ecc71',
                            '#e9ecef'
                        ],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    }
                }
            });
            
            // 健康趋势图表
            const healthTrendCtx = document.getElementById('health-trend-chart').getContext('2d');
            healthTrendChart = new Chart(healthTrendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '健康评分',
                        data: [],
                        borderColor: '#0f4c81',
                        backgroundColor: 'rgba(15, 76, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '健康评分'
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 测试数据类型选择
            document.getElementById('test-data-type').addEventListener('change', function() {
                const type = this.value;
                
                // 显示/隐藏自定义数据设置
                if (type === 'custom') {
                    document.getElementById('custom-data-settings').classList.remove('hidden');
                } else {
                    document.getElementById('custom-data-settings').classList.add('hidden');
                }
            });
            
            // 开始测试按钮
            document.getElementById('start-test').addEventListener('click', function() {
                startTest();
            });
            
            // 清除数据按钮
            document.getElementById('clear-test').addEventListener('click', function() {
                clearTest();
            });
            
            // 清除日志按钮
            document.getElementById('clear-log').addEventListener('click', function() {
                clearLog();
            });
        }
        
        // 开始测试
        function startTest() {
            // 清除之前的测试数据
            clearTest();
            
            // 获取测试参数
            const testDataType = document.getElementById('test-data-type').value;
            totalTestData = parseInt(document.getElementById('test-data-count').value);
            
            // 显示测试进度
            document.getElementById('test-progress').classList.remove('hidden');
            
            // 重置测试计数
            testDataCount = 0;
            
            // 更新进度
            updateProgress();
            
            // 记录测试日志
            logTest(`开始测试，数据类型: ${testDataType}，数据数量: ${totalTestData}`);
            
            // 开始发送测试数据
            testInterval = setInterval(() => {
                // 生成测试数据
                let testData;
                
                switch (testDataType) {
                    case 'normal':
                        testData = generateNormalData();
                        break;
                    case 'warning':
                        testData = generateWarningData();
                        break;
                    case 'anomaly':
                        testData = generateAnomalyData();
                        break;
                    case 'custom':
                        testData = generateCustomData();
                        break;
                }
                
                // 添加时间戳
                testData.timestamp = Date.now();
                testData.time = new Date().toLocaleTimeString();
                
                // 发送数据到平台层
                const result = platformLayer.receiveData(testData);
                
                // 记录健康历史
                healthHistory.push({
                    time: testData.time,
                    score: result.healthScore
                });
                
                // 更新测试计数
                testDataCount++;
                
                // 更新进度
                updateProgress();
                
                // 检查测试是否完成
                if (testDataCount >= totalTestData) {
                    clearInterval(testInterval);
                    completeTest();
                }
            }, 100); // 每100毫秒发送一次数据
        }
        
        // 生成正常数据
        function generateNormalData() {
            return {
                temperature: generateRandomValue(20, 30, 0.5),
                voltage: generateRandomValue(3.2, 3.4, 0.01),
                current: generateRandomValue(140, 160, 0.2),
                vibration: generateRandomValue(0.01, 0.03, 0.001),
                displacement: generateRandomValue(0.05, 0.15, 0.01),
                tilt: generateRandomValue(0.3, 0.7, 0.05)
            };
        }
        
        // 生成警告数据
        function generateWarningData() {
            return {
                temperature: generateRandomValue(32, 35, 0.5), // 温度偏高
                voltage: generateRandomValue(3.0, 3.2, 0.01),   // 电压偏低
                current: generateRandomValue(160, 180, 0.2),    // 电流偏高
                vibration: generateRandomValue(0.06, 0.08, 0.001), // 振动强度偏高
                displacement: generateRandomValue(0.6, 0.8, 0.01), // 位移偏大
                tilt: generateRandomValue(3.0, 4.0, 0.05)       // 倾斜角度偏大
            };
        }
        
        // 生成异常数据
        function generateAnomalyData() {
            return {
                temperature: generateRandomValue(35, 40, 0.5),  // 温度过高
                voltage: generateRandomValue(2.8, 3.0, 0.01),   // 电压过低
                current: generateRandomValue(180, 200, 0.2),    // 电流过高
                vibration: generateRandomValue(0.08, 0.1, 0.001), // 振动强度过高
                displacement: generateRandomValue(0.8, 1.0, 0.01), // 位移过大
                tilt: generateRandomValue(4.0, 5.0, 0.05)       // 倾斜角度过大
            };
        }
        
        // 生成自定义数据
        function generateCustomData() {
            return {
                temperature: parseFloat(document.getElementById('custom-temperature').value),
                voltage: parseFloat(document.getElementById('custom-voltage').value),
                current: parseFloat(document.getElementById('custom-current').value),
                vibration: parseFloat(document.getElementById('custom-vibration').value),
                displacement: parseFloat(document.getElementById('custom-displacement').value),
                tilt: parseFloat(document.getElementById('custom-tilt').value)
            };
        }
        
        // 生成随机值，带有一定的趋势
        function generateRandomValue(min, max, step) {
            // 基于当前时间生成一个伪随机数
            const random = Math.sin(Date.now() * 0.001) * 0.5 + 0.5;
            let value = min + random * (max - min);
            
            // 添加一些小的随机波动
            value += (Math.random() - 0.5) * step;
            
            // 确保值在范围内
            return Math.max(min, Math.min(max, value));
        }
        
        // 更新进度
        function updateProgress() {
            const progress = Math.min(100, Math.round((testDataCount / totalTestData) * 100));
            
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${progress}%`;
            document.getElementById('data-count-text').textContent = `${testDataCount}/${totalTestData} 数据点`;
        }
        
        // 完成测试
        function completeTest() {
            // 记录测试日志
            logTest('测试完成');
            
            // 生成健康评估报告
            const healthReport = platformLayer.generateHealthReport();
            
            // 生成数据质量报告
            const dataQualityReport = platformLayer.generateDataQualityReport();
            
            // 获取异常日志
            const anomalyLog = platformLayer.getAnomalyLog();
            
            // 更新测试结果
            updateTestResults(healthReport, dataQualityReport, anomalyLog);
            
            // 显示测试结果
            document.getElementById('test-results').classList.remove('hidden');
            
            // 生成测试结论
            generateTestConclusion(healthReport, dataQualityReport, anomalyLog);
        }
        
        // 更新测试结果
        function updateTestResults(healthReport, dataQualityReport, anomalyLog) {
            // 更新健康评分
            document.getElementById('health-score-value').textContent = healthReport.healthScore.current;
            updateGauge(healthScoreGauge, healthReport.healthScore.current, 0, 100, getHealthScoreColor(healthReport.healthScore.current));
            
            // 更新数据质量分析
            document.getElementById('data-completeness').textContent = dataQualityReport.metrics.completeness.value;
            document.getElementById('data-completeness-bar').style.width = `${dataQualityReport.metrics.completeness.score}%`;
            document.getElementById('data-completeness-bar').className = `h-2.5 rounded-full ${getScoreColor(dataQualityReport.metrics.completeness.score)}`;
            
            document.getElementById('data-accuracy').textContent = dataQualityReport.metrics.accuracy.value;
            document.getElementById('data-accuracy-bar').style.width = `${dataQualityReport.metrics.accuracy.score}%`;
            document.getElementById('data-accuracy-bar').className = `h-2.5 rounded-full ${getScoreColor(dataQualityReport.metrics.accuracy.score)}`;
            
            document.getElementById('data-stability').textContent = dataQualityReport.metrics.stability.value;
            document.getElementById('data-stability-bar').style.width = `${dataQualityReport.metrics.stability.score}%`;
            document.getElementById('data-stability-bar').className = `h-2.5 rounded-full ${getScoreColor(dataQualityReport.metrics.stability.score)}`;
            
            // 更新异常检测结果
            document.getElementById('anomaly-count').textContent = `${anomalyLog.length} 个`;
            document.getElementById('anomaly-rate').textContent = `${healthReport.anomalyStats.rate}%`;
            
            // 更新关键指标分析
            updateMetricsTable(healthReport.keyMetrics);
            
            // 更新健康趋势图
            updateHealthTrendChart();
        }
        
        // 更新仪表盘
        function updateGauge(gauge, value, min, max, color) {
            const percentage = ((value - min) / (max - min)) * 100;
            const remaining = 100 - percentage;
            
            gauge.data.datasets[0].data = [percentage, remaining];
            gauge.data.datasets[0].backgroundColor[0] = color;
            gauge.update();
        }
        
        // 获取健康评分颜色
        function getHealthScoreColor(score) {
            if (score >= 90) {
                return '#2ecc71'; // 优秀 - 绿色
            } else if (score >= 80) {
                return '#3498db'; // 良好 - 蓝色
            } else if (score >= 70) {
                return '#3498db'; // 正常 - 蓝色
            } else if (score >= 60) {
                return '#f39c12'; // 警告 - 黄色
            } else {
                return '#e74c3c'; // 危险 - 红色
            }
        }
        
        // 获取评分颜色
        function getScoreColor(score) {
            if (score >= 90) {
                return 'bg-green-500';
            } else if (score >= 80) {
                return 'bg-green-400';
            } else if (score >= 70) {
                return 'bg-blue-400';
            } else if (score >= 60) {
                return 'bg-yellow-400';
            } else {
                return 'bg-red-500';
            }
        }
        
        // 更新关键指标表格
        function updateMetricsTable(metrics) {
            const tableBody = document.getElementById('metrics-table');
            tableBody.innerHTML = '';
            
            // 温度
            addMetricRow(tableBody, '温度', metrics.temperature);
            
            // 电压
            addMetricRow(tableBody, '压力值', metrics.voltage);
            
            // 电流
            addMetricRow(tableBody, '震动程度', metrics.current);
            
            // 振动强度
            addMetricRow(tableBody, '振动强度', metrics.vibration);
            
            // 位移
            addMetricRow(tableBody, '位移', metrics.displacement);
            
            // 倾斜角度
            addMetricRow(tableBody, '倾斜角度', metrics.tilt);
        }
        
        // 添加指标行
        function addMetricRow(tableBody, name, metric) {
            const row = document.createElement('tr');
            
            // 获取正常范围
            let normalRange = '';
            switch (name) {
                case '温度':
                    normalRange = `${platformLayer.config.normalRanges.temperature.min}-${platformLayer.config.normalRanges.temperature.max}${platformLayer.config.normalRanges.temperature.unit}`;
                    break;
                case '压力值':
                    normalRange = `${platformLayer.config.normalRanges.voltage.min}-${platformLayer.config.normalRanges.voltage.max}${platformLayer.config.normalRanges.voltage.unit}`;
                    break;
                case '震动程度':
                    normalRange = `${platformLayer.config.normalRanges.current.min}-${platformLayer.config.normalRanges.current.max}${platformLayer.config.normalRanges.current.unit}`;
                    break;
                case '振动强度':
                    normalRange = `0-${platformLayer.config.normalRanges.vibration.max}${platformLayer.config.normalRanges.vibration.unit}`;
                    break;
                case '位移':
                    normalRange = `0-${platformLayer.config.normalRanges.displacement.max}${platformLayer.config.normalRanges.displacement.unit}`;
                    break;
                case '倾斜角度':
                    normalRange = `0-${platformLayer.config.normalRanges.tilt.max}${platformLayer.config.normalRanges.tilt.unit}`;
                    break;
            }
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">${metric.mean} ${metric.unit}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">${metric.stdDev} ${metric.unit}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">${metric.min} ${metric.unit}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">${metric.max} ${metric.unit}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">${normalRange}</td>
            `;
            
            tableBody.appendChild(row);
        }
        
        // 更新健康趋势图表
        function updateHealthTrendChart() {
            // 准备图表数据
            const labels = healthHistory.map(h => h.time);
            const scores = healthHistory.map(h => h.score);
            
            // 更新图表
            healthTrendChart.data.labels = labels;
            healthTrendChart.data.datasets[0].data = scores;
            healthTrendChart.update();
        }
        
        // 生成测试结论
        function generateTestConclusion(healthReport, dataQualityReport, anomalyLog) {
            const conclusionElement = document.getElementById('test-conclusion');
            
            // 分析测试结果
            let conclusion = '';
            
            // 健康评分结论
            conclusion += `<p class="mb-2"><strong>健康评分分析：</strong>当前健康评分为 ${healthReport.healthScore.current}/100，${healthReport.healthScore.status.text}状态。`;
            
            if (healthReport.healthScore.current >= 90) {
                conclusion += ' 系统运行状态优秀，各项指标均在正常范围内。</p>';
            } else if (healthReport.healthScore.current >= 80) {
                conclusion += ' 系统运行状态良好，各项指标基本正常。</p>';
            } else if (healthReport.healthScore.current >= 70) {
                conclusion += ' 系统运行状态一般，部分指标接近警告阈值。</p>';
            } else if (healthReport.healthScore.current >= 60) {
                conclusion += ' 系统运行状态警告，多项指标超出正常范围，建议检查。</p>';
            } else {
                conclusion += ' 系统运行状态危险，多项指标严重超出正常范围，需要立即处理。</p>';
            }
            
            // 健康趋势结论
            const trend = parseFloat(healthReport.healthScore.trend);
            conclusion += `<p class="mb-2"><strong>健康趋势分析：</strong>健康评分${trend > 0 ? '呈上升' : trend < 0 ? '呈下降' : '保持稳定'}趋势，变化率为 ${Math.abs(trend)}/分钟。`;
            
            if (trend > 0.1) {
                conclusion += ' 系统状态正在改善。</p>';
            } else if (trend < -0.1) {
                conclusion += ' 系统状态正在恶化，建议密切关注。</p>';
            } else {
                conclusion += ' 系统状态保持稳定。</p>';
            }
            
            // 异常检测结论
            conclusion += `<p class="mb-2"><strong>异常检测分析：</strong>共检测到 ${anomalyLog.length} 个异常，异常率为 ${healthReport.anomalyStats.rate}%。`;
            
            if (anomalyLog.length === 0) {
                conclusion += ' 未检测到任何异常，系统运行稳定。</p>';
            } else if (anomalyLog.length < totalTestData * 0.05) {
                conclusion += ' 检测到少量异常，可能是临时性干扰引起的。</p>';
            } else if (anomalyLog.length < totalTestData * 0.1) {
                conclusion += ' 检测到一定数量的异常，需要关注系统稳定性。</p>';
            } else {
                conclusion += ' 检测到大量异常，系统存在严重问题，需要立即处理。</p>';
            }
            
            // 数据质量结论
            conclusion += `<p class="mb-2"><strong>数据质量分析：</strong>数据质量评分为 ${dataQualityReport.dataQualityScore}/100，${dataQualityReport.qualityLevel.name}等级。</p>`;
            
            // 总体结论
            conclusion += '<p><strong>总体结论：</strong>';
            
            if (healthReport.healthScore.current >= 80 && anomalyLog.length < totalTestData * 0.05 && dataQualityReport.dataQualityScore >= 80) {
                conclusion += '平台层功能正常，系统运行稳定，数据质量良好。</p>';
            } else if (healthReport.healthScore.current >= 70 && anomalyLog.length < totalTestData * 0.1 && dataQualityReport.dataQualityScore >= 70) {
                conclusion += '平台层功能基本正常，系统运行基本稳定，但存在一些需要关注的问题。</p>';
            } else {
                conclusion += '平台层功能存在异常，系统运行不稳定，建议进行详细检查和修复。</p>';
            }
            
            // 更新结论
            conclusionElement.innerHTML = conclusion;
            
            // 记录测试日志
            logTest('测试结论已生成');
        }
        
        // 清除测试
        function clearTest() {
            // 清除测试进度
            clearInterval(testInterval);
            
            // 隐藏测试进度和结果
            document.getElementById('test-progress').classList.add('hidden');
            document.getElementById('test-results').classList.add('hidden');
            
            // 重置进度
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-text').textContent = '0%';
            document.getElementById('data-count-text').textContent = '0/0 数据点';
            
            // 重置测试计数
            testDataCount = 0;
            totalTestData = 0;
            
            // 重置健康历史
            healthHistory = [];
            
            // 重置图表
            healthTrendChart.data.labels = [];
            healthTrendChart.data.datasets[0].data = [];
            healthTrendChart.update();
            
            // 记录测试日志
            logTest('测试数据已清除');
        }
        
        // 记录测试日志
        function logTest(message) {
            const logElement = document.getElementById('test-log');
            
            // 如果是第一条日志，清除提示信息
            if (logElement.innerHTML.includes('测试日志将显示在这里...')) {
                logElement.innerHTML = '';
            }
            
            // 创建日志条目
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-1';
            logEntry.innerHTML = `<span class="text-gray-500">[${new Date().toLocaleTimeString()}]</span> ${message}`;
            
            // 添加到日志顶部
            logElement.insertBefore(logEntry, logElement.firstChild);
        }
        
        // 清除日志
        function clearLog() {
            const logElement = document.getElementById('test-log');
            logElement.innerHTML = '<div class="text-gray-500 italic">测试日志将显示在这里...</div>';
            
            // 记录测试日志
            logTest('测试日志已清除');
        }
        
        // 更新时间
        function updateTime() {
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }
    </script>
</body>
</html>
